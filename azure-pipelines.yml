# Azure DevOps Pipeline for TGHarker.SecureChat
# Builds Docker images and deploys to Azure Container Apps
#
# Required Pipeline Variables (configure in Azure DevOps):
#   ACR_NAME                  - Azure Container Registry name
#   ACR_LOGIN_SERVER          - ACR login server URL
#   ACR_SERVICE_CONNECTION    - Service connection for ACR
#   AZURE_SERVICE_CONNECTION  - Service connection for Azure
#   RESOURCE_GROUP            - Target resource group
#   CONTAINER_APP_ENV         - Container Apps environment name
#   STORAGE_CONNECTION_STRING - Azure Storage connection string (used for both table and blob storage)
#   AUTH_AUTHORITY            - JWT authentication authority URL
#   AUTH_AUDIENCE             - JWT authentication audience
#   CORS_ALLOWED_ORIGINS      - Comma-separated list of allowed CORS origins
#   FRONTEND_BASE_URL         - Frontend application base URL
#   VAPID_SUBJECT             - VAPID subject (e.g. mailto:admin@harker.dev)
#   VAPID_PUBLIC_KEY           - VAPID public key (base64url)
#   VAPID_PRIVATE_KEY          - VAPID private key (base64url, mark as secret)

trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - securechat-client/**
      - '*.md'
      - .github/**
      - docs/**

variables:
  # Container Registry
  acrName: '$(ACR_NAME)'
  acrLoginServer: '$(ACR_LOGIN_SERVER)'

  # Container Apps
  resourceGroup: '$(RESOURCE_GROUP)'
  containerAppEnv: '$(CONTAINER_APP_ENV)'

  # Image names
  webapiImageName: 'securechat-webapi'
  siloImageName: 'securechat-silo'

  # Build configuration
  dockerfilePath_WebApi: 'TGHarker.SecureChat.WebApi/Dockerfile'
  dockerfilePath_Silo: 'TGHarker.SecureChat.Silo/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Images'
    jobs:
      - job: BuildImages
        displayName: 'Build Docker Images'
        pool:
          name: 'Tylers'
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'

          - task: Docker@2
            displayName: 'Build SecureChat WebApi Image'
            inputs:
              command: build
              repository: '$(webapiImageName)'
              dockerfile: '$(dockerfilePath_WebApi)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Build SecureChat Silo Image'
            inputs:
              command: build
              repository: '$(siloImageName)'
              dockerfile: '$(dockerfilePath_Silo)'
              buildContext: '$(Build.SourcesDirectory)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push SecureChat WebApi Image'
            inputs:
              command: push
              repository: '$(webapiImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push SecureChat Silo Image'
            inputs:
              command: push
              repository: '$(siloImageName)'
              containerRegistry: '$(ACR_SERVICE_CONNECTION)'
              tags: |
                $(tag)
                latest

  # Uncomment this stage when database migrations are needed
  # - stage: Migrate
  #   displayName: 'Apply Database Migrations'
  #   dependsOn: Build
  #   condition: succeeded()
  #   jobs:
  #     - job: ApplyMigrations
  #       displayName: 'Apply EF Core Migrations'
  #       pool:
  #         name: 'Tylers'
  #       steps:
  #         - task: UseDotNet@2
  #           displayName: 'Install .NET SDK'
  #           inputs:
  #             packageType: 'sdk'
  #             version: '10.x'
  #
  #         - script: |
  #             dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
  #             echo "Installed dotnet-ef version:"
  #             $HOME/.dotnet/tools/dotnet-ef --version
  #           displayName: 'Install EF Core Tools'
  #
  #         - script: dotnet restore
  #           displayName: 'Restore NuGet Packages'
  #
  #         - script: dotnet build TGHarker.SecureChat.Silo/TGHarker.SecureChat.Silo.csproj --no-restore
  #           displayName: 'Build Silo Project'
  #
  #         - script: |
  #             echo "Running migration..."
  #             $HOME/.dotnet/tools/dotnet-ef database update \
  #               --project TGHarker.SecureChat.Silo/TGHarker.SecureChat.Silo.csproj \
  #               --startup-project TGHarker.SecureChat.Silo/TGHarker.SecureChat.Silo.csproj \
  #               --no-build \
  #               --verbose
  #           displayName: 'Apply Migrations'
  #           env:
  #             CONNECTION_STRING: $(POSTGRES_CONNECTION_STRING)

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToACA
        displayName: 'Deploy to Azure Container Apps'
        pool:
          name: 'Tylers'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    AZ_VENV="$HOME/.azure-cli-venv"
                    if [ ! -f "$AZ_VENV/bin/az" ]; then
                      echo "Creating virtual environment and installing Azure CLI..."
                      python3 -m venv "$AZ_VENV"
                      "$AZ_VENV/bin/pip" install --upgrade pip
                      "$AZ_VENV/bin/pip" install azure-cli
                    else
                      echo "Azure CLI already installed"
                    fi
                    echo "##vso[task.prependpath]$AZ_VENV/bin"
                    "$AZ_VENV/bin/az" version
                  displayName: 'Install Azure CLI'

                - task: AzureCLI@2
                  displayName: 'Deploy SecureChat Silo'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name securechat-silo \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating securechat-silo container app..."
                        az containerapp create \
                          --name securechat-silo \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress internal \
                          --min-replicas 1 \
                          --max-replicas 3 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__tableStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__blobStorage=$(STORAGE_CONNECTION_STRING)" \
                            "Orleans__ClusterId=securechat-cluster" \
                            "Orleans__ServiceId=securechat-service" \
                            "Vapid__Subject=$(VAPID_SUBJECT)" \
                            "Vapid__PublicKey=$(VAPID_PUBLIC_KEY)" \
                            "Vapid__PrivateKey=$(VAPID_PRIVATE_KEY)"
                      else
                        echo "Updating securechat-silo container app..."
                        az containerapp update \
                          --name securechat-silo \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(siloImageName):$(tag) \
                          --set-env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__tableStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__blobStorage=$(STORAGE_CONNECTION_STRING)" \
                            "Orleans__ClusterId=securechat-cluster" \
                            "Orleans__ServiceId=securechat-service" \
                            "Vapid__Subject=$(VAPID_SUBJECT)" \
                            "Vapid__PublicKey=$(VAPID_PUBLIC_KEY)" \
                            "Vapid__PrivateKey=$(VAPID_PRIVATE_KEY)"
                      fi

                - task: AzureCLI@2
                  displayName: 'Deploy SecureChat WebApi'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Check if container app exists
                      EXISTS=$(az containerapp show \
                        --name securechat-webapi \
                        --resource-group $(resourceGroup) \
                        --query "name" -o tsv 2>/dev/null || echo "")

                      if [ -z "$EXISTS" ]; then
                        echo "Creating securechat-webapi container app..."
                        az containerapp create \
                          --name securechat-webapi \
                          --resource-group $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $(acrLoginServer)/$(webapiImageName):$(tag) \
                          --registry-server $(acrLoginServer) \
                          --registry-identity system \
                          --target-port 8080 \
                          --ingress external \
                          --min-replicas 1 \
                          --max-replicas 5 \
                          --cpu 0.5 \
                          --memory 1Gi \
                          --env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__tableStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__blobStorage=$(STORAGE_CONNECTION_STRING)" \
                            "Authentication__Authority=$(AUTH_AUTHORITY)" \
                            "Authentication__Audience=$(AUTH_AUDIENCE)" \
                            "Cors__AllowedOrigins=$(CORS_ALLOWED_ORIGINS)" \
                            "Frontend__BaseUrl=$(FRONTEND_BASE_URL)" \
                            "Orleans__ClusterId=securechat-cluster" \
                            "Orleans__ServiceId=securechat-service" \
                            "Vapid__PublicKey=$(VAPID_PUBLIC_KEY)"
                      else
                        echo "Updating securechat-webapi container app..."
                        az containerapp update \
                          --name securechat-webapi \
                          --resource-group $(resourceGroup) \
                          --image $(acrLoginServer)/$(webapiImageName):$(tag) \
                          --set-env-vars \
                            "ASPNETCORE_ENVIRONMENT=Production" \
                            "ConnectionStrings__tableStorage=$(STORAGE_CONNECTION_STRING)" \
                            "ConnectionStrings__blobStorage=$(STORAGE_CONNECTION_STRING)" \
                            "Authentication__Authority=$(AUTH_AUTHORITY)" \
                            "Authentication__Audience=$(AUTH_AUDIENCE)" \
                            "Cors__AllowedOrigins=$(CORS_ALLOWED_ORIGINS)" \
                            "Frontend__BaseUrl=$(FRONTEND_BASE_URL)" \
                            "Orleans__ClusterId=securechat-cluster" \
                            "Orleans__ServiceId=securechat-service" \
                            "Vapid__PublicKey=$(VAPID_PUBLIC_KEY)"
                      fi

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Checking deployment status..."

                      # Get WebApi URL
                      WEBAPI_URL=$(az containerapp show \
                        --name securechat-webapi \
                        --resource-group $(resourceGroup) \
                        --query "properties.configuration.ingress.fqdn" -o tsv)

                      echo "SecureChat WebApi URL: https://$WEBAPI_URL"

                      # Check silo status
                      SILO_STATUS=$(az containerapp show \
                        --name securechat-silo \
                        --resource-group $(resourceGroup) \
                        --query "properties.runningStatus" -o tsv)

                      echo "SecureChat Silo Status: $SILO_STATUS"
